<!DOCTYPE html>
<html>
<head>
    <!--  Android Chrome Color-->
    <meta name="theme-color" content="#EE6E73">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <title>Configurator</title>
    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.3/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.3/jstree.min.js"></script>
    <style type="text/css" media="screen">
        body {
            margin: 0;
            padding: 0;
        }
        
        #editor {
            position: fixed;
            top: 68px;
            right: 0;
            bottom: 0;
        }
        
        #fbheader {
            display: block;
        }
        
        .filename {
            margin-left: 10px;
        }
        
        .green {
            color: #0f0;
        }
        
        .red {
            color: #f00;
        }
        
        .dropdown-content {
            min-width: 200px;
        }
        
        .ace_optionsMenuEntry input {
            position: relative !important;
            left: 0 !important;
            opacity: 100 !important;
        }
        
        .ace_optionsMenuEntry select {
            position: relative !important;
            left: 0 !important;
            opacity: 100 !important;
            display: block !important;
        }
    </style>
</head>

<body>
    <div class="navbar-fixed">
        <nav class="light-blue hoverable">
            <div class="nav-wrapper">
                <ul class="left">
                    <li><a href="#" data-activates="slide-out" class="waves-effect waves-light button-collapse show-on-large"><i class="material-icons">folder</i></a></li>
                </ul>
                <ul class="right">
                    <li><a class="waves-effect waves-light" href="#modal_save"><i class="material-icons">save</i></a></li>
                    <li><a class="waves-effect waves-light dropdown-button" href="#!" data-activates="dropdown_tools" data-beloworigin="true"><i class="material-icons right">more_vert</i></a></li>
                </ul>
            </div>
        </nav>
    </div>
    <ul id="dropdown_tools" class="dropdown-content z-depth-4">
        <li><a onclick="toggle_whitespace()">Whitespace</a></li>
        <li><a onclick="toggle_fold()">Fold</a></li>
        <li><a onclick="toggle_highlightSelectedWord()">Highlight</a></li>
        <li><a target="_blank" href="https://github.com/ajaxorg/ace/wiki/Default-Keyboard-Shortcuts">Ace Keyboard Shortcuts</a></li>
        <li><a target="_blank" href="https://home-assistant.io/help/">Need HASS Help?</a></li>
        <li><a target="_blank" href="https://home-assistant.io/components/">HASS Components</a></li>
        <li><a href="#modal_about">About</a></li>
        <li class="divider"></li>
        <li><a href="#" class="ace_settings-collapse" onclick="settings()">Settings</a></li>
        <!--<li><a href="#" data-activates="ace_settings" class="ace_settings-collapse">Settings</a></li>-->
        <li><a href="#modal_restart">Restart HASS</a></li>
    </ul>
    <div id="modal_save" class="modal">
        <div class="modal-content">
            <h4>Save</h4>
            <p>Do you really want to save?</p>
        </div>
        <div class="modal-footer"> <a href="#!" class=" modal-action modal-close waves-effect waves-red btn-flat">No</a> <a onclick="save()" class=" modal-action modal-close waves-effect waves-green btn-flat">Yes</a> </div>
    </div>
    <div id="modal_restart" class="modal">
        <div class="modal-content">
            <h4>Restart</h4>
            <p>Do you really want to restart HASS?</p>
        </div>
        <div class="modal-footer"> <a href="#!" class=" modal-action modal-close waves-effect waves-red btn-flat">No</a> <a onclick="restart()" class=" modal-action modal-close waves-effect waves-green btn-flat">Yes</a> </div>
    </div>
    <div id="modal_about" class="modal">
        <div class="modal-content">
            <h4>About</h4>
            <p>Version: <a class="$versionclass" href="https://github.com/danielperna84/hass-poc-configurator/releases/latest" target="_blank">$current</a></p>
        </div>
        <div class="modal-footer"> <a class=" modal-action modal-close waves-effect btn-flat">OK</a> </div>
    </div>
    <div class="row">
        <div class="col m4 l3 hide-on-small-only">
            </br>
            <div class="input-field col s12">
                <select onchange="insert(this.value)">
                    <option value="" disabled selected>Choose your option</option>
                    <option value="event">Event</option>
                    <option value="mqtt">MQTT</option>
                    <option value="numberic_state">Numeric State</option>
                    <option value="state">State</option>
                    <option value="sun">Sun</option>
                    <option value="template">Template</option>
                    <option value="time">Time</option>
                    <option value="zone">Zone</option>
                </select>
                <label>Trigger Platform</label>
            </div>
            <div class="input-field col s12">
                <select id="events" onchange="insert(this.value)"> </select>
                <label>Events</label>
            </div>
            <div class="input-field col s12">
                <select id="entities" onchange="insert(this.value)"> </select>
                <label>Entities</label>
            </div>
            <div class="input-field col s12">
                <select onchange="insert(this.value)">
                    <option value="" disabled selected>Choose your option</option>
                    <option value="numeric_state">Numeric state</option>
                    <option value="state">State</option>
                    <option value="sun">Sun</option>
                    <option value="template">Template</option>
                    <option value="time">Time</option>
                    <option value="zone">Zone</option>
                </select>
                <label>Conditions</label>
            </div>
            <div class="input-field col s12">
                <select id="services" onchange="insert(this.value)"> </select>
                <label>Services</label>
            </div>
        </div>
        <div class="col s12 m8 l9 z-depth-3 hoverable" id="editor"></div>
    </div>
    <div>
        <ul id="slide-out" class="side-nav">
            <div id="filebrowser"></div>
            <div class="row">
                <div class="hide-on-med-and-up">
                    <div class="input-field col s12">
                        <select onchange="insert(this.value)">
                            <option value="" disabled selected>Choose your option</option>
                            <option value="event">Event</option>
                            <option value="mqtt">MQTT</option>
                            <option value="numberic_state">Numeric State</option>
                            <option value="state">State</option>
                            <option value="sun">Sun</option>
                            <option value="template">Template</option>
                            <option value="time">Time</option>
                            <option value="zone">Zone</option>
                        </select>
                        <label>Trigger Platform</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="hide-on-med-and-up">
                    <div class="input-field col s12">
                        <select id="events_side" onchange="insert(this.value)"> </select>
                        <label>Events</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="hide-on-med-and-up">
                    <div class="input-field col s12">
                        <select id="entities_side" onchange="insert(this.value)"> </select>
                        <label>Entities</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="hide-on-med-and-up">
                    <div class="input-field col s12">
                        <select onchange="insert(this.value)">
                            <option value="" disabled selected>Choose your option</option>
                            <option value="numeric_state">Numeric state</option>
                            <option value="state">State</option>
                            <option value="sun">Sun</option>
                            <option value="template">Template</option>
                            <option value="time">Time</option>
                            <option value="zone">Zone</option>
                        </select>
                        <label>Conditions</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="hide-on-med-and-up">
                    <div class="input-field col s12">
                        <select id="services_side" onchange="insert(this.value)"> </select>
                        <label>Services</label>
                    </div>
                </div>
            </div>
            </br>
            </br>
            </br>
        </ul>
    </div>
    <div class="row center">
        <ul id="ace_settings" class="side-nav">
            <li><a onclick="Materialize.toast('¯\\_(ツ)_/¯', 2000)">Coming Soon . . .</a></li>
            <form class="row center col s12" action="#">
                <p>
                    <input type="checkbox" id="test1" />
                    <label for="test1">Animated Scroll</label>
                </p>
                <p>
                    <input type="checkbox" id="test2" />
                    <label for="test2">Behaviours Enabled</label>
                </p>
                <p>
                    <input type="checkbox" id="test3" />
                    <label for="test3">Display Indent Guides</label>
                </p>
            </form>
            <div class="row">
                <div class="input-field col s6">
                    <input value="150" id="drag_delay" type="text" class="validate">
                    <label class="active" for="drag_delay">Drag Delay</label>
                </div>
            </div>
            <form class="col s12" action="#">
                <p>
                    <input type="checkbox" id="test4" />
                    <label for="test4">Fade Fold Widgets</label>
                </p>
            </form>
        </ul>
    </div>
    <input type="hidden" id="currentfile" value="" />
</body>
<!--  Scripts-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $('select').material_select();
        $('.modal').modal();
        $('.dropdown-button').dropdown({
            inDuration: 300,
            outDuration: 225,
            constrainWidth: true,
            hover: false,
            gutter: 0,
            belowOrigin: true,
            alignment: 'right',
            stopPropagation: false
        });
        $('.button-collapse').sideNav({
            menuWidth: 350,
            edge: 'left',
            closeOnClick: false,
            draggable: true
        });
        $('.ace_settings-collapse').sideNav({
            menuWidth: 400, // Default is 300
            edge: 'right', // Choose the horizontal origin
            closeOnClick: true, // Closes side-nav on <a> clicks, useful for Angular/Meteor
            draggable: true // Choose whether you can drag to open on touch screens
        });
        listdir('.');
    });
</script>
<script>
    var bootstrap = $bootstrap;
    if (bootstrap.hasOwnProperty("events")) {
        var events = document.getElementById("events");
        for (var i = 0; i < bootstrap.events.length; i++) {
            var option = document.createElement("option");
            option.value = bootstrap.events[i].event;
            option.text = bootstrap.events[i].event;
            events.add(option);
        }
        var events = document.getElementById("events_side");
        for (var i = 0; i < bootstrap.events.length; i++) {
            var option = document.createElement("option");
            option.value = bootstrap.events[i].event;
            option.text = bootstrap.events[i].event;
            events.add(option);
        }
        var entities = document.getElementById("entities");
        for (var i = 0; i < bootstrap.states.length; i++) {
            var option = document.createElement("option");
            option.value = bootstrap.states[i].entity_id;
            option.text = bootstrap.states[i].attributes.friendly_name + ' (' + bootstrap.states[i].entity_id + ')';
            entities.add(option);
        }
        var entities = document.getElementById("entities_side");
        for (var i = 0; i < bootstrap.states.length; i++) {
            var option = document.createElement("option");
            option.value = bootstrap.states[i].entity_id;
            option.text = bootstrap.states[i].attributes.friendly_name + ' (' + bootstrap.states[i].entity_id + ')';
            entities.add(option);
        }
        var services = document.getElementById("services");
        for (var i = 0; i < bootstrap.services.length; i++) {
            for (var k in bootstrap.services[i].services) {
                var option = document.createElement("option");
                option.value = bootstrap.services[i].domain + '.' + k;
                option.text = bootstrap.services[i].domain + '.' + k;
                services.add(option);
            }
        }
        var services = document.getElementById("services_side");
        for (var i = 0; i < bootstrap.services.length; i++) {
            for (var k in bootstrap.services[i].services) {
                var option = document.createElement("option");
                option.value = bootstrap.services[i].domain + '.' + k;
                option.text = bootstrap.services[i].domain + '.' + k;
                services.add(option);
            }
        }
        var options = $('#events option');
        var arr = options.map(function(_, o) {
            return {
                t: $(o).text(),
                v: o.value
            };
        }).get();
        arr.sort(function(o1, o2) {
            var t1 = o1.t.toLowerCase(),
                t2 = o2.t.toLowerCase();
            return t1 > t2 ? 1 : t1 < t2 ? -1 : 0;
        });
        options.each(function(i, o) {
            o.value = arr[i].v;
            $(o).text(arr[i].t);
        });
        var options = $('#entities option');
        var arr = options.map(function(_, o) {
            return {
                t: $(o).text(),
                v: o.value
            };
        }).get();
        arr.sort(function(o1, o2) {
            var t1 = o1.t.toLowerCase(),
                t2 = o2.t.toLowerCase();
            return t1 > t2 ? 1 : t1 < t2 ? -1 : 0;
        });
        options.each(function(i, o) {
            o.value = arr[i].v;
            $(o).text(arr[i].t);
        });
        var options = $('#services option');
        var arr = options.map(function(_, o) {
            return {
                t: $(o).text(),
                v: o.value
            };
        }).get();
        arr.sort(function(o1, o2) {
            var t1 = o1.t.toLowerCase(),
                t2 = o2.t.toLowerCase();
            return t1 > t2 ? 1 : t1 < t2 ? -1 : 0;
        });
        options.each(function(i, o) {
            o.value = arr[i].v;
            $(o).text(arr[i].t);
        });
    }

    function listdir(path) {
        $.get(encodeURI("api/listdir?path=" + path), function(data) {
            renderpath(data);
        });
    }
    
    function renderitem(itemdata) {
        var item = document.createElement('a');
        item.classList.add('collection-item');
        item.href = '#';
        var iicon = document.createElement('i');
        iicon.classList.add('material-icons');
        if (itemdata.type == 'dir') {
            iicon.innerHTML = 'folder';
            item.setAttribute("onclick", "listdir('" + encodeURI(itemdata.fullpath) + "')");
        }
        else {
            iicon.innerHTML = 'insert_drive_file';
            item.setAttribute("onclick", "loadfile('" + encodeURI(itemdata.fullpath) + "')");
        }
        item.appendChild(iicon);
        var itext = document.createElement('span');
        itext.innerHTML = itemdata.name;
        itext.classList.add('filename');
        item.appendChild(itext);
        return item;
    }
    
    function renderpath(dirdata) {
        var filebrowser = document.getElementById("filebrowser");
        while (filebrowser.firstChild) {
            filebrowser.removeChild(filebrowser.firstChild);
        }
        var collection = document.createElement('div');
        collection.classList.add('collection');
        collection.classList.add('with-header');
        var fbheader = document.createElement('span');
        fbheader.innerHTML = dirdata.abspath;
        fbheader.classList.add('collection-header');
        fbheader.id = 'fbheader';
        collection.appendChild(fbheader);
        var up = document.createElement('a');
        up.classList.add('collection-item');
        up.href = '#';
        up.id = "uplink";
        up.setAttribute("onclick", "listdir('" + encodeURI(dirdata.parent) + "')")
        var upicon = document.createElement('i');
        upicon.classList.add('material-icons');
        upicon.innerHTML = 'folder';
        up.appendChild(upicon);
        var uptext = document.createElement('span');
        uptext.innerHTML = '..';
        up.appendChild(uptext);
        collection.appendChild(up);
        
        for (var i = 0; i < dirdata.content.length; i++) {
            collection.appendChild(renderitem(dirdata.content[i]));
        }
        
        filebrowser.appendChild(collection);
    }
    
    var whitespacestatus = false;
    var foldstatus = true;
    var highlightwords = true;

    function toggle_highlightSelectedWord() {
        highlightwords = !highlightwords;
        editor.setOption("highlightSelectedWord", highlightwords);
    }

    function toggle_whitespace() {
        whitespacestatus = !whitespacestatus;
        editor.setOption("showInvisibles", whitespacestatus);
    }

    function toggle_fold() {
        if (foldstatus) {
            editor.getSession().foldAll();
        } else {
            editor.getSession().unfold();
        }
        foldstatus = !foldstatus;
    }

    function loadfile(filepath) {
        $.get("api/file?filename=" + filepath, function(data) {
            editor.setValue(data);
            editor.selection.selectFileStart();
            editor.focus();
            document.getElementById('currentfile').value = filepath;
        });
    }

    function restart() {
        $.get("api/restart", function(resp) {
            if (resp.length == 0) {
                var $toastContent = $("<div><pre>Restarting HASS</pre></div>");
                Materialize.toast($toastContent, 2000);
            } else {
                var $toastContent = $("<div><pre>" + resp + "</pre></div>");
                Materialize.toast($toastContent, 2000);
            }
        });
    }

    function save() {
        var filepath = document.getElementById('currentfile').value;
        if (filepath.length > 0) {
            data = new Object();
            data.filename = filepath;
            data.text = editor.getValue()
            $.post("api/save", data).done(function(resp) {
                var $toastContent = $("<div><pre>" + resp + "</pre></div>");
                Materialize.toast($toastContent, 2000);
            });
        }
    }
    
    function settings() {
        editor.execCommand('showSettingsMenu');
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ext-modelist.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    if (localStorage.hasOwnProperty("pochass")) {
        editor.setOptions(JSON.parse(localStorage.pochass));
    } else {
        editor.getSession().setMode("ace/mode/yaml");
        editor.setOption("showInvisibles", whitespacestatus);
        editor.setOption("useSoftTabs", true);
        editor.setOption("displayIndentGuides", true);
        editor.setOption("highlightSelectedWord", highlightwords);
        editor.$blockScrolling = Infinity;
    }

    function insert(text) {
        var pos = editor.selection.getCursor();
        var end = editor.session.insert(pos, text);
        editor.selection.setRange({
            start: pos,
            end: end
        });
        editor.focus();
    }
</script>
</html>